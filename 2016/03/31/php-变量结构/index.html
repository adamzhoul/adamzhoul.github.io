<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description"><meta name="keywords" content="Hexo, nginx, vim, php"><title>php-变量结构 - 就是路过</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.ico"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com/adamzhoul"><span>Github</span></a></li><li><a href="https://www.v2ex.com/"><span>V2EX</span></a></li><li><a href="/tags/"><span>标签</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="http://callfiles.ueibo.com/hexo-theme-laughing/post_background.jpg"><div class="post-title"><h1 class="title">php-变量结构</h1><ul class="meta"><li><i class="icon icon-author"></i>过路人</li><li><i class="icon icon-clock"></i>7 Minutes</li><li><i class="icon icon-calendar"></i>March 30, 2016</li></ul></div></div><div class="article-content" style="max-width:800px"><h2>整体结构：_zval_struct </h2>

<p>php作为一个弱类型语言。通过一个通用的数据格式存储所有变量。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _zval_struct &#123;</div><div class="line">	z_value value;					<span class="comment">//存储真实的值</span></div><div class="line">	zend_unit ref_count__gc;		<span class="comment">//引用计数</span></div><div class="line">	zend_uchar type;				<span class="comment">//类型</span></div><div class="line">	zend_uchar is_ref__gc;  		<span class="comment">//是否被引用,0、1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在php5.3 引入新的垃圾回收机制之后，变量名修改为：</p>
<pre><code>refcount =&gt; ref_count__gc
is__ref  =&gt; is_ref__gc
</code></pre><a id="more"></a>
<p>变量的类型包括：<br>IS_NULL、IS_BOOL、 IS_LONG、IS_DOUBLE、IS_STRING、IS_ARRAY、IS_OBJECT和IS_RESOURCE 等</p>
<p>上面的数据结构基本上给出了变量的顶级结构，用于语言层面。接下来就具体看看内部的一些数据结构。</p>
<h2>变量值的存储：z_value </h2>

<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> _z_value</div><div class="line">&#123;</div><div class="line">	<span class="keyword">long</span> lval;</div><div class="line">	<span class="keyword">double</span> dval;</div><div class="line">	<span class="keyword">struct</span> &#123;</div><div class="line">		<span class="keyword">char</span> *val; 		<span class="comment">//c中的字符串，以\0结尾</span></div><div class="line">		<span class="keyword">int</span> len;			<span class="comment">//存储字符串的长度</span></div><div class="line">	&#125;str;</div><div class="line">	HashTable *ht;			<span class="comment">//哈希，存储数组</span></div><div class="line">	zend_object_value obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>显然，这里用union这种结构是为了节省空间。这里包含的类型就有：长整形、double类型、字符串类型、hash类型（数组）、类对象。</p>
<p>这里hashtable类型和类类型，又有自己专门的数据结构负责。</p>
<p>1、PHP的哈希表实现中使用了两个数据结构HashTable和Bucket。<br>2、类对象保存方式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">	<span class="keyword">typedef</span> <span class="keyword">struct</span> _zend_object_value &#123; </div><div class="line">		zend_object_handle handle; <span class="comment">//unsigned int类型,EG(objects_store).object_buckets的索引 </span></div><div class="line">		zend_object_handlers *handlers;&#125; zend_object_value;</div></pre></td></tr></table></figure>
<p>PHP的对象只有在运行时才会被创建,EG宏,这是一个全局结构体用于保存在运行 时的数据。 其中就包括了用来保存所有被创建的对象的对象池,EG(objects_store),而object对象值内容 的zend_object_handle域就是当前 对象在对象池中所在的索引,handlers字段则是将对象进行操作时的处 理函数保存起来。 这个结构体及对象相关的类的结构_zend_class_entry。</p>
<p></p><h2>hash的实现</h2><br>hash的实现需要解决三个问题：<p></p>
<pre><code>1. 实现哈希函数
2. 冲突的解决
3. 操作接口的实现
</code></pre><p>hash函数很多，这里暂不讨论；<br>冲突的解决，基本就是链表法或者开放寻址法；<br>接口基本就是增删改查。</p>
<p>注：PHP中的哈希表实现在Zend/zend_hash.c。</p>
<p>hashtable结构体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _hashtable&#123;</div><div class="line">	uint nTableSize;				<span class="comment">//hash bucket的大小，2的n次方</span></div><div class="line">	uint nTableMask;				<span class="comment">//掩码，2的n次方减1，其实就是做与操作</span></div><div class="line">	uint nNumberOfElements; 	<span class="comment">//hash Bucket中当前存在的元素个数,count()函数会直接返回此值</span></div><div class="line">	ulong nNextFreeElement;    <span class="comment">//下一个数字索引的位置</span></div><div class="line">	</div><div class="line">	Bucket *pInternalPointer; 	<span class="comment">//当前遍历的指针(foreach比for快的原因之一)</span></div><div class="line">	Bucket *pListHead;			<span class="comment">//储数组头元素指针</span></div><div class="line">	Bucket *pListTail;         <span class="comment">//存储数组尾元素指针</span></div><div class="line">	Bucket **arBuckets; 		 <span class="comment">//存储hash数组</span></div><div class="line">	</div><div class="line">	<span class="keyword">dtor_func_t</span> pDestructor;  <span class="comment">// 在删除元素时执行的回调函数,用于资源的释放</span>	zend_bool persistent;  	   <span class="comment">//指出了Bucket内存分配的方式。如果persisient为 TRUE,则使用操作系统本身的内存分配函数为Bucket分配内存,否则使用PHP的内存分配函数。</span></div><div class="line">	</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> nApplyCount; <span class="comment">// 标记当前hash Bucket被递归访问的次数(防止多次递 归)</span></div><div class="line">	zend_bool bApplyProtection; <span class="comment">// 标记当前hash桶允许不允许多次访问,不允许时,最多只 能递归3次</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> ZEND_DEBUG</span></div><div class="line">	<span class="keyword">int</span> inconsistent;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>bucket 数据结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">	<span class="keyword">typedef</span> <span class="keyword">struct</span> bucket &#123; </div><div class="line">		ulong h;		uint nKeyLength;		<span class="keyword">void</span> *pData; pDataPtr		<span class="keyword">void</span> *pDataPtr;</div><div class="line">				</div><div class="line">		<span class="keyword">struct</span> bucket *pListNext;</div><div class="line">		<span class="keyword">struct</span> bucket *pListLast; </div><div class="line">		<span class="keyword">struct</span> bucket *pNext; </div><div class="line">		<span class="keyword">struct</span> bucket *pLast;							<span class="keyword">char</span> arKey[<span class="number">1</span>]; </div><div class="line">&#125; Bucket;</div></pre></td></tr></table></figure>
<p><img src="/2016/03/31/php-变量结构/hashInsertRule.png" alt="logo"></p>
</div><div class="article-meta" style="max-width:800px"><div class="tags"><i class="icon icon-tag"></i><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/">php</a><span class="tag-list-count">3</span></li></ul></div><div class="categories"><i class="icon icon-category"></i><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a><span class="category-list-count">3</span></li></ul></div></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2016/07/29/css选择器/"><i class="icon icon-arror-left"></i></a></li><li><a href="/2016/03/11/php函数 array/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/adamzhoul" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://segmentfault.com/u/adam_show" title="SegmentFault" target="_blank"><i class="icon icon-segmentfault"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2017 就是路过<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>